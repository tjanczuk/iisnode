<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  
  <!-- creating MSIs for local apps http://blogs.msdn.com/b/astebner/archive/2007/11/18/6385121.aspx -->

  <?define sourcedir="$(var.ProjectDir)..\..\..\build\$(var.Configuration)\x86\" ?>
  
  <?include version_autogenerated.wxi ?> <!-- generated in pre-build steps -->

  <Product Id="*" 
           Name="iisnode for iis express 7.x" 
           Language="1033" 
           Version="$(var.version)"
           Manufacturer="Microsoft Corporation"            
           UpgradeCode="1d60944c-b9ce-4a71-a7c0-0384eb884b1e">

    <Package InstallerVersion="200" Compressed="yes" Platform="x86" />

    <MajorUpgrade AllowSameVersionUpgrades="yes" 
                  DowngradeErrorMessage="A later version of [ProductName] is already installed and cannot be replaced. If you intend to downgrade the version of [ProductName], please uninstall the current version manually." />
    
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />    

    <Property Id="ALLUSERS" Secure="yes"/>
    
    <Property Id="APPCMDEXE">
      <DirectorySearch Id="IISExpressDir" Path="[ProgramFilesFolder]IIS Express">
        <FileSearch Name="appcmd.exe" />
      </DirectorySearch>
    </Property>

    <Condition Message="Setting the ALLUSERS property is not allowed because iisnode for iis express 7.x is a per-user application.">
      <![CDATA[NOT ALLUSERS]]>
    </Condition>
    
    <Condition Message="IIS Express 7.x or later must be installed before iisnode for IIS Express 7.x installation.">
      <![CDATA[Installed or APPCMDEXE]]>
    </Condition>
    
    <PropertyRef Id="WIX_DIR_COMMON_DOCUMENTS"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="inetsrvdir" Name="IIS Express">
        </Directory>
        <Directory Id="iisnoderootdir" Name="iisnode-express">
        </Directory>
      </Directory>
      <Directory Id="WIX_DIR_COMMON_DOCUMENTS">
        <Directory Id="iisnodesamples" Name="iisnode-express">
        </Directory>
      </Directory>
    </Directory>

    <DirectoryRef Id="TARGETDIR">
      <Component Id="RegistryEntries" Guid="{BB4D6F3A-AC2E-4393-AD1B-1BDC0A2CD4B7}">
        <RegistryKey Root="HKLM"
                     Key="Software\Microsoft\IIS Extensions\iisnode-express"
              Action="createAndRemoveOnUninstall">
          <RegistryValue Type="integer" Name="Install" Value="1" KeyPath="yes"/>
          <RegistryValue Type="string" Name="Version" Value="$(var.version)"/>
          <RegistryValue Type="string" Value=""/>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <Feature Id="iisnode4iis" Title="Hosting node.js applications in IIS Express 7.x" Level="1" Description="IIS 7.x native module for hosting node.js applications in IIS Express 7.x">
      <ComponentGroupRef Id="allfiles" />
      <ComponentRef Id="RegistryEntries" />      
    </Feature>

    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\..\iisnode-msi\License.rtf" />
    <UIRef Id="WixUI_Minimal" />

    <InstallExecuteSequence>
      
      <!-- make sure the applicationhost.config for the personal IISExpress installation is created -->

      <Custom Action="EnsureIISExpressConfig" After="InstallFiles">REMOVE&lt;>"ALL"</Custom>

      <!-- install/rollback/uninstall iisnode section under system.webServer -->

      <Custom Action="AddIisnodeSection" After="EnsureIISExpressConfig">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="RollbackAddIisnodeSection" After="EnsureIISExpressConfig">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="UndoAddIisnodeSection" After="EnsureIISExpressConfig">REMOVE="ALL"</Custom>

      <!-- remove iisnode module registration -->

      <Custom Action="RemoveIisnodeModuleRegistration" After="AddIisnodeSection" />
      
      <!-- install/rollback/uninstall iisnode module -->

      <Custom Action="AddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="RollbackAddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="UndoAddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE="ALL"</Custom>
            
    </InstallExecuteSequence>

  </Product>

  <?include iisnodefiles.wxi ?>
  <?include customactions.wxi ?>

</Wix>
